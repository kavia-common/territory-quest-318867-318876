{"is_source_file": true, "format": "JavaScript", "description": "This file implements authentication middleware for a Node.js Express application, utilizing Supabase for JWT token verification. It provides functions for authenticating users, optional authentication, ownership verification, and utility helpers to access user info from requests.", "external_files": ["../utils/logger.js", "@supabase/supabase-js"], "external_methods": ["createClient (from '@supabase/supabase-js')"], "published": ["authenticate", "optionalAuth", "isAuthenticated", "getCurrentUserId", "getCurrentUser", "requireOwnership", "getSupabaseClient"], "classes": [], "methods": [{"name": "getSupabaseClient", "description": "Lazy initializes and returns the Supabase client using environment variables."}, {"name": "authenticate", "description": "Middleware to validate JWT token from Authorization header and attach user info to the request object."}, {"name": "optionalAuth", "description": "Middleware that attempts authentication but proceeds even if no token is provided."}, {"name": "isAuthenticated", "description": "Helper to check if the request is authenticated."}, {"name": "getCurrentUserId", "description": "Helper to retrieve current user ID from the request."}, {"name": "getCurrentUser", "description": "Helper to retrieve current user object from the request."}, {"name": "requireOwnership", "description": "Middleware to enforce resource ownership based on user ID parameter."}], "calls": ["createClient", "supabaseClient.auth.getUser"], "search-terms": ["auth middleware", "Supabase JWT verification", "authorization header", "getUser", "ownership middleware", "authOptional", "auth helper functions"], "state": 2, "file_id": 11, "knowledge_revision": 48, "git_revision": "f7a828da9e7f0829a4404b1fbb21d9f52533e2ef", "revision_history": [{"38": "c2b4720579c8e11ff8f0ec060c27f46eeddaf35b"}, {"48": "f7a828da9e7f0829a4404b1fbb21d9f52533e2ef"}], "ctags": [{"_type": "tag", "name": "authHeader", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^    const authHeader = req.headers.authorization;$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "authenticate", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^export const authenticate = async (req, res, next) => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "errorMessage", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^      let errorMessage = 'Invalid or expired token';$/", "language": "JavaScript", "kind": "variable"}, {"_type": "tag", "name": "getCurrentUser", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^export const getCurrentUser = (req) => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "getCurrentUserId", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^export const getCurrentUserId = (req) => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "getSupabaseClient", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^const getSupabaseClient = () => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "isAuthenticated", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^export const isAuthenticated = (req) => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "optionalAuth", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^export const optionalAuth = async (req, res, next) => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "requireOwnership", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^export const requireOwnership = (userIdParamName = 'userId') => {$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "resourceUserId", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^    const resourceUserId = req.params[userIdParamName];$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "supabase", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^let supabase = null;$/", "language": "JavaScript", "kind": "variable"}, {"_type": "tag", "name": "supabaseClient", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^    const supabaseClient = getSupabaseClient();$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "token", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^    const token = authHeader.substring(7); \\/\\/ Remove 'Bearer ' prefix$/", "language": "JavaScript", "kind": "constant"}, {"_type": "tag", "name": "token", "path": "/home/kavia/workspace/code-generation/territory-quest-318867-318876/game_backend/src/middleware/auth.js", "pattern": "/^    const token = authHeader.substring(7);$/", "language": "JavaScript", "kind": "constant"}], "hash": "8675d9130a5e8889cfc9f15f3314094d", "format-version": 4, "code-base-name": "game_backend", "filename": "game_backend/src/middleware/auth.js", "fields": [{"name": "let errorMessage = 'Invalid or expired token';", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "let supabase = null;", "scope": "", "scopeKind": "", "description": "unavailable"}]}